// Lake 20160503
// https://hellolake.duapp.com
// https://github.com/hellolake/lake.js
var bmap_ak = {
    key:"5yG2Ep6NoV7OWUErStfE73El",		//Baidu Map API Key for test, not sure its stability. 测试用AK,不保证其稳定性.
    ver:"2.0"							//Version of API. API版本
};
!function(){window.lake||(window.lake={}),lake.bmap=function(a,b){b&&b.key&&(bmap_ak.key=b.key),b&&b.ver&&(bmap_ak.ver=b.ver);var c=this.bmap;c.ak=bmap_ak,c.loaded?a.call(c):c.fns.push(a),c.script||(c.script=document.createElement("script"),c.script.type="text/javascript",c.script.src="http://api.map.baidu.com/api?v="+c.ak.ver+"&ak="+c.ak.key+"&callback=lake.bmap.callback",document.body.appendChild(c.script))},lake.bmap.loaded=!1,lake.bmap.fns=[],lake.bmap.callback=function(){function a(a){this.map=a,this.policy=1,this.color="#FF3300",this.opacity=.65,this.width=4,this.style="solid",this.focus=this.visible=this.exist=!0}var b,c,d;for(window.located=document.createEvent("HTMLEvents"),window.located.initEvent("located",!1,!1),b=this,this._bmap||(this._bmap=function(a,c){function d(){var a=g.getBounds(),b=a.getSouthWest(),a=a.getNorthEast(),c=g.getDistance(b,a),d=g.getSize();g.resolution=c/Math.sqrt(Math.pow(d.width,2)+Math.pow(d.height,2)),g.lngres=(a.lng-b.lng)/d.width,g.latres=(a.lat-b.lat)/d.height}function e(){document.removeEventListener("located",e,!0),g.addOverlay(g.marker),g.addOverlay(g.circle)}function f(a){g.marker&&g.marker.update&&g.marker.update(a.type,lake.bmap.location,lake.bmap.accuracy),g.circle&&g.circle.update&&g.circle.update(a.type,lake.bmap.location,lake.bmap.accuracy)}var g,h;BMap.Map.call(this,a,c),this.container=a,this.dblzoom=!0,this.inited=!1,this.fns=[],this.circle=this.marker=this.latres=this.lngres=this.resolution=null,g=this,document.addEventListener("located",function(){g.dispatchEvent("located",{location:lake.bmap.location,accuracy:lake.bmap.accuracy})}),g.addEventListener("moveend",d,!0),g.addEventListener("zoomend",d,!0),h=document.createElement("div"),h.style.cssText="padding:8px;background-color:#0af;border:.125em solid #fff;border-radius:50%;box-shadow:0 0 3px rgba(0,0,0,.3);position:absolute;z-index:909;-webkit-transform:translate3d(-50%,-50%,0);transform:translate3d(-50%,-50%,0);display:none;",g.marker=b.overlay(h,{oninit:function(){this.update=function(a,b){"located"==a&&this.setPosition(b)}}}),h=document.createElement("div"),h.style.cssText="padding:0;background-color:rgba(0,0,0,.125);border-radius:50%;position:absolute;z-index:808;-webkit-transform:translate3d(-50%,-50%,0);transform:translate3d(-50%,-50%,0);display:none;",g.circle=b.overlay(h,{oninit:function(){this.update=function(a,b,c){"located"==a&&this.setPosition(b),this.element.style.padding=c/this.map.resolution+"px"}}}),lake.bmap.location?e():document.addEventListener("located",e,!0),document.addEventListener("located",f),g.addEventListener("moveend",f),g.addEventListener("zoomend",f)},this._bmap.prototype=new BMap.Map,this._bmap.prototype.constructor=this._bmap,this._bmap.prototype.setCenter=function(a){function b(){BMap.Map.prototype.setCenter.call(c,a)}var c=this;c.inited?b():c.fns.push(b)},this._bmap.prototype.setZoom=function(a){function b(){BMap.Map.prototype.setZoom.call(c,a)}var c=this;c.inited?b():c.fns.push(b)},this._bmap.prototype.addOverlay=function(a){function b(){BMap.Map.prototype.addOverlay.call(c,a)}var c=this;c.inited?b():c.fns.push(b)},this._bmap.prototype.enableDoubleClickZoom=function(){this.dblzoom=!0},this._bmap.prototype.disableDoubleClickZoom=function(){this.dblzoom=!1},this._bmap.prototype.user=function(a,b){function c(a){if(lake.bmap.location)d.addOverlay(a);else{var b=function(){document.removeEventListener("located",b,!0),d.addOverlay(a)};document.addEventListener("located",b,!0)}}var d=this;a instanceof BMap.Overlay&&(d.removeOverlay(d.marker),d.marker=a,c(d.marker)),b instanceof BMap.Overlay&&(d.removeOverlay(d.circle),d.circle=b,c(d.circle)),!1===a&&(d.removeOverlay(d.marker),d.marker=null),!1===b&&(d.removeOverlay(d.circle),d.circle=null)},this._bmap.prototype.path=function(b,c,d,e){var f=new a(this);return f.draw(b,c,d,e),f}),a.prototype.draw=function(a,b,c,d){function e(a){var f,d=g.points.length;if(d>h){if(d-1>h){if(f=g.role.getStatus(),0!=f){for(h;d>h;h++)g.waypoints[h]=g.points[h];return c.call(g,f,h,g.waypoints[h]),void 0}a=a.getPlan(0).getRoute(0),f=a.getPath(),0==h&&g.waypoints.push(f[0]),g.waypoints.push(f[f.length-1]),f=new BMap.Polyline(f,{strokeColor:g.color,strokeOpacity:g.opacity,strokeWeight:g.width,strokeStyle:g.style}),g.exist&&g.map.addOverlay(f),!g.visible&&f.hide(),g.lines.push(f),g.distance+=a.getDistance(!1),g.role.clearResults()}b&&b.call(g,h,g.waypoints[h]),h++,d-1>h?g.role.search(g.waypoints[h],g.points[h+1]):h==d-1&&(e(),g.focus&&g.map.setViewport(g.waypoints,{margins:[24,24,24,24]}))}}function f(){g.role.search(g.points[h],g.points[h+1])}if("[object Object]"==Object.prototype.toString.call(c)&&(d=c,c=void 0),"[object Object]"==Object.prototype.toString.call(b)&&(d=b,c=b=void 0),"function"!=typeof c&&(c=void 0),"function"!=typeof b&&(b=void 0),d&&d.color&&(this.color=d.color),d&&d.opacity&&(this.opacity=d.opacity),d&&d.width&&(this.width=d.width),d&&d.style&&(this.style=d.style),d&&d.policy&&(this.policy=d.policy),d&&"boolean"==typeof d.focus&&(this.focus=d.focus),"[object Array]"==Object.prototype.toString.call(a)&&(this.points=a),this.points&&0!=this.points.length){this.role||(this.role=new BMap.DrivingRoute(this.map,{renderOptions:{map:this.map,autoViewport:!1}})),this.role.setPolicy(this.policy),this.role.setSearchCompleteCallback(e),this.lines&&this.remove(),this.exist=!0,this.lines=[],this.waypoints=[],this.distance=0;var g=this,h=0;this.map.inited?f():this.map.fns.push(f)}else console.error("Arg[0]:points must be a location/point array.")},a.prototype.setPolicy=function(a){this.policy=a,this.role&&this.role.setPolicy(a)},a.prototype.setColor=function(a){if(this.color=a,this.lines)for(var b=0,c=this.lines.length;c>b;b++)this.lines[b].setStrokeColor(a),lake.bmap.touchable&&(this.remove(),this.add())},a.prototype.setOpacity=function(a){if(this.opacity=a,this.lines)for(var b=0,c=this.lines.length;c>b;b++)this.lines[b].setStrokeOpacity(a),lake.bmap.touchable&&(this.remove(),this.add())},a.prototype.setWidth=function(a){if(this.width=a,this.lines){for(var b=0,c=this.lines.length;c>b;b++)this.lines[b].setStrokeWeight(a);lake.bmap.touchable&&(this.remove(),this.add())}},a.prototype.setStyle=function(a){if(this.style=a,this.lines)for(var b=0,c=this.lines.length;c>b;b++)this.lines[b].setStrokeStyle(a),lake.bmap.touchable&&(this.remove(),this.add())},a.prototype.enableFocus=function(){this.focus=!0},a.prototype.disableFocus=function(){this.focus=!1},a.prototype.show=function(){if(this.visible=!0,this.lines)for(var a=0,b=this.lines.length;b>a;a++)this.lines[a].show()},a.prototype.hide=function(){if(this.visible=!1,this.lines)for(var a=0,b=this.lines.length;b>a;a++)this.lines[a].hide()},a.prototype.add=function(){if(this.exist=!0,this.lines)for(var a=0,b=this.lines.length;b>a;a++)this.map.addOverlay(this.lines[a])},a.prototype.remove=function(){if(this.exist=!1,this.lines)for(var a=0,b=this.lines.length;b>a;a++)this.map.removeOverlay(this.lines[a])},this.loaded=!0,c=0,d=this.fns.length;d>c;c++)this.fns[c].call(this)},lake.bmap.new=function(a,b,c,d){function e(){var b,a=f.fns.length;if(a>0){for(b=0;a>b;b++)f.fns[b]();f.fns=[]}}var f,g,h;if(this.loaded){if("[object Object]"==Object.prototype.toString.call(c)&&(d=c,c=void 0),"number"==typeof b&&(c=b,b=void 0),"[object Object]"!=Object.prototype.toString.call(b)||b instanceof BMap.Point||(d=b,b=void 0),c||(c=13),"string"==typeof a)a=document.querySelector(a);else if(1!=a.nodeType)return console.error("Arg[0]:Container must be a selector string or an element."),void 0;if(this.count?this.count++:this.count=1,f=new this._bmap(a,d),f.enableScrollWheelZoom(),BMap.Map.prototype.disableDoubleClickZoom.call(f),f.addEventListener("dblclick",function(a){this.dblzoom&&this.centerAndZoom(a.point,this.getZoom()+1)}),"string"==typeof b)g=this,h=new BMap.LocalSearch("全国"),f.addEventListener("moving",function(){1<g.count&&f.dispatchEvent("onloadcode")}),h.setSearchCompleteCallback(function(a){0!==h.getStatus()?console.error("Arg[1]:Unknown location."):(f.centerAndZoom(a.getPoi(0).point,c),f.inited=!0,e())}),1==this.count?h.search(b):setTimeout(function(){h.search(b)},30*this.count);else{if(b instanceof BMap.Point)f.centerAndZoom(b,c);else{if(b)return console.error("Arg[1]:Location must be a location name or BMap Point."),void 0;f.centerAndZoom(new BMap.Point(116.404,39.915),c)}f.inited=!0,e()}return f}console.error("Create map must run in callback fn with 'lake.bmap(callback)'.")},lake.bmap.gps=function(a,b,c){var d,e;if(lake.bmap.loaded){if(d=this.gps,d.enableHighAccuracy=!0,d.timeout=3e4,d.maximumAge=7e3,d.success=[],d.error=[],"[object Object]"==Object.prototype.toString.call(b)&&(c=b,b=void 0),"[object Object]"==Object.prototype.toString.call(a)&&(c=a,b=a=void 0),"[object Object]"==Object.prototype.toString.call(c))for(e in c)d[e]=c[e];"function"==typeof b&&(d.error=[b]),"function"==typeof a&&(d.success=[a]),d.geo||(d.geo=new BMap.Geolocation),d.interval&&d.stop()}else console.error("BMap Geolocation must run in callback fn with 'lake.bmap(callback)'.")},lake.bmap.gps.locate=function(){if(this.geo){var a=this;a.geo.getCurrentPosition(function(b){if(0==this.getStatus()){lake.bmap.location=b.point,lake.bmap.accuracy=b.accuracy,document.dispatchEvent(located);for(var c=0,d=a.success.length;d>c;c++)a.success[c].call(a,b)}else for(b=0,c=a.error.length;c>b;b++)a.error[b].call(a,this.getStatus())},{enableHighAccuracy:a.enableHighAccuracy,timeout:a.timeout,maximumAge:a.maximumAge})}else console.error("Use 'lake.bmap.gps(success,error,options)' to initialize the GPS first.")},lake.bmap.gps.run=function(){if(this.geo){this.interval?this.stop():this.locate();var a=this;this.interval=setInterval(function(){a.locate()},a.maximumAge+100)}else console.error("Use 'lake.bmap.gps(success,error,options)' to initialize the GPS first.")},lake.bmap.gps.stop=function(){clearInterval(this.interval),this.interval=null},lake.bmap.gps.add=function(a,b){"string"==typeof a&&"function"==typeof b&&("success"===a?0>this.success.indexOf(b)&&this.success.push(b):"error"===a&&0>this.error.indexOf(b)&&this.error.push(b))},lake.bmap.gps.del=function(a,b){"string"==typeof a&&("function"==typeof b?"success"===a?this.success.splice(this.success.indexOf(b),1):"error"===a&&this.error.splice(this.error.indexOf(b),1):b||("success"===a?this.success=[]:"error"===a&&(this.error=[])))},lake.bmap.c2p=function(a,b,c,d){function e(a){0===a.status?b(a.points):c&&c&&c(a.message)}"boolean"==typeof c&&(d=c,c=void 0);var f=!0,g=[];if(function h(a){if(2==a.length&&"number"==typeof a[0]&&"number"==typeof a[1])g.push(new BMap.Point(a[0],a[1]));else if(a.lng&&a.lat)g.push(new BMap.Point(a.lng,a.lat));else if(a.longitude&&a.latitude)g.push(new BMap.Point(a.longitude,a.latitude));else if(a.length)for(var b=0,c=a.length;c>b&&f;b++)h(a[b]);else f=!1,console.error("Can not convert "+a+".")}(a),f){if(!0===d)return b(g),g;(new BMap.Convertor).translate(g,1,5,e)}},lake.bmap.touchable="ontouchstart"in window,lake.bmap.platform=lake.bmap.touchable?{type:"Mobile",start:"touchstart",move:"touchmove",end:"touchend",cancel:"touchcancel"}:{type:"PC",start:"mousedown",move:"mousemove",end:"mouseup",cancel:"mouseup"},lake.bmap.overlay=function(a,b,c){var d=null,e=null,f=!1,g=!1;if("[object Object]"!=Object.prototype.toString.call(b)||b instanceof BMap.Point||(c=b,b=void 0),c&&!0===c.slip&&(g=!0),c&&!0===c.draggable&&(f=!0),c&&"function"==typeof c.oninit&&(d=c.oninit),c&&"function"==typeof c.ondraw&&(e=c.ondraw),!(b instanceof BMap.Point)){if(b)return console.error("Arg[1]:point must be a BMap Point or empty."),void 0;b=new BMap.Point(0,0)}if(1!=a.nodeType){if("string"!=typeof a)return console.error("Arg[0]:element must be a selector string or an element."),void 0;a=document.querySelector(a)}return this.overlay._event||(this.overlay._event=function(a){if(a.touches){var b=a.touches[0]||a.changedTouches[0];this.clientX=b.clientX,this.clientY=b.clientY,this.screenX=b.screenX,this.screenY=b.screenY,this.pageX=b.pageX,this.pageY=b.pageY,this.touches=a.touches,this.targetTouches=a.targetTouches,this.changedTouches=a.changedTouches}else this.clientX=a.clientX,this.clientY=a.clientY,this.screenX=a.screenX,this.screenY=a.screenY,this.pageX=a.pageX,this.pageY=a.pageY;this.srcElement=a.srcElement,this.domEvent=a},this.overlay._event.prototype={preventDefault:function(){this.domEvent.preventDefault()},stopImmediatePropagation:function(){this.domEvent.stopImmediatePropagation()},stopPropagation:function(){this.domEvent.stopPropagation()}}),this.overlay._overlay||(this.overlay._overlay=function(a,b,c,d,e,f){this.element=a,this.point=b,this.slip=f,this.draggable=e,this.oninit=c,this.ondraw=d,this.dragging=this.inited=!1},this.overlay._overlay.prototype=new BMap.Overlay,this.overlay._overlay.prototype.constructor=this.overlay._overlay,this.overlay._overlay.prototype.initialize=function(a){var b,c,d,e,f,g;return this.map=a,this.map.getPanes().labelPane.appendChild(this.element),b=this,a=this.element,c=!1,d=!0,e=!1,f=lake.bmap.platform,g=lake.bmap.overlay._event,a.style.position="absolute",a.style.cursor="pointer",this.inited||(a.addEventListener("click",function(a){a.stopPropagation()}),a.addEventListener("dblclick",function(a){b.dispatchEvent("dblclick",new g(a))}),a.addEventListener(f.start,function(a){b.slip&&a.stopPropagation(),a.preventDefault(),b.dispatchEvent(f.start,new g(a)),c=d=!0}),a.addEventListener(f.move,function(a){b.slip&&a.stopPropagation(),b.dispatchEvent(f.move,new g(a)),c&&(d=!1)}),a.addEventListener(f.end,function(a){b.slip&&a.stopPropagation(),b.dispatchEvent(f.end,new g(a)),d&&b.dispatchEvent("click",new g(a)),d=!0}),a.addEventListener("touchcancel",function(a){b.dispatchEvent("touchcancel",new g(a))}),a.addEventListener("mouseenter",function(a){b.dispatchEvent("mouseover",new g(a)),e=!0}),a.addEventListener("mouseleave",function(a){b.dispatchEvent("mouseout",new g(a)),e=!1}),a.addEventListener("mouseover",function(a){b.dispatchEvent("mouseover",new g(a))}),a.addEventListener("mouseout",function(a){b.dispatchEvent("mouseout",new g(a))}),!lake.bmap.touchable&&document.addEventListener("click",function(a){c&&!e&&a.stopPropagation(),c=!1},!0)),this.oninit&&this.oninit.call(this,this),this.inited=!0,!0===this.draggable&&this.enableDragging(),a},this.overlay._overlay.prototype.draw=function(){var a=this.map.pointToOverlayPixel(this.point);this.element.style.left=a.x+"px",this.element.style.top=a.y+"px",this.ondraw&&this.ondraw.call(this,this)},this.overlay._overlay.prototype.setPosition=function(a){a instanceof BMap.Point&&(this.point=a,this.map&&this.draw())},this.overlay._overlay.prototype.getPosition=function(){return this.point},this.overlay._overlay.prototype.getMap=function(){return this.map},this.overlay._overlay.prototype.getElement=function(){return this.element},this.overlay._overlay.prototype._dragmappan=function(){this._dragoverlaymove(-this.panx,-this.pany),this.map.panBy(this.panx,this.pany,{noAnimation:!0})},this.overlay._overlay.prototype._dragoverlaymove=function(a,b){var c=this.element;0!=a&&(c.style.left=c.offsetLeft+a+"px"),0!=b&&(c.style.top=c.offsetTop+b+"px"),this.point=this.map.overlayPixelToPoint({x:c.offsetLeft,y:c.offsetTop})},this.overlay._overlay.prototype._dragstartfn=function(a){!0===this.draggable&&(a.preventDefault(),a.stopPropagation(),this.dragstart=!0,this.maprect=this.map.getContainer().getBoundingClientRect(),this.mapleft=this.maprect.left,this.mapright=this.maprect.right,this.maptop=this.maprect.top,this.mapbottom=this.maprect.bottom,this._oldX=a.touches?a.touches[0].clientX:a.clientX,this._oldY=a.touches?a.touches[0].clientY:a.clientY)},this.overlay._overlay.prototype._dragmovefn=function(a){var b,c,d,e,f,g;!0===this.dragstart&&(a.preventDefault(),a.stopPropagation(),b=lake.bmap.overlay._event,this.dragging||this.dispatchEvent("dragstart",new b(a)),this.dragging=!0,this.dispatchEvent("dragging",new b(a)),b=a.touches?a.touches[0].clientX:a.clientX,a=a.touches?a.touches[0].clientY:a.clientY,c=this.mapleft,d=this.mapright,e=this.maptop,f=this.mapbottom,this.movex=b>c&&d>b?b-this._oldX:0,this.panx=c+32>=b?8:b>=d-32?-8:0,this.movey=a>e&&f>a?a-this._oldY:0,this.pany=e+32>=a?8:a>=f-32?-8:0,this._oldX=b,this._oldY=a,this._dragoverlaymove(this.movex,this.movey),0==this.panx&&0==this.pany?this.paning&&(this.paning=!1,clearInterval(this.interval)):this.paning||(this.paning=!0,g=this,this.interval=setInterval(function(){g._dragmappan()},32)))},this.overlay._overlay.prototype._dragendfn=function(a){!0===this.dragstart&&(this.dragstart=!1,this.paning&&(this.paning=!1,clearInterval(this.interval)),this.dragging&&(a.preventDefault(),a.stopPropagation(),this.dragging=!1,this.dispatchEvent("dragend",new lake.bmap.overlay._event(a))))},this.overlay._overlay.prototype.enableDragging=function(){if(this.inited){this.draggable=!0;var a=this,b=lake.bmap.platform;this.dragstartfn||(this.dragstartfn=function(b){a._dragstartfn.call(a,b)},this.dragmovefn=function(b){a._dragmovefn.call(a,b)},this.dragendfn=function(b){a._dragendfn.call(a,b)}),this._attach||(this.addEventListener(b.start,this.dragstartfn),document.addEventListener(b.move,this.dragmovefn,!0),document.addEventListener(b.end,this.dragendfn,!0),this._attach=!0)}else console.error("Enable dragging must put overlay into map first.")},this.overlay._overlay.prototype.disableDragging=function(){if(this.inited){this.draggable=this._attach=!1;var a=lake.bmap.platform;this.removeEventListener(a.start,this.dragstartfn),document.removeEventListener(a.move,this.dragmovefn,!0),document.removeEventListener(a.end,this.dragendfn,!0)}},this.overlay._overlay.prototype.enableSlip=function(){this.slip=!0},this.overlay._overlay.prototype.disableSlip=function(){this.slip=!1}),new this.overlay._overlay(a,b,d,e,f,g)},lake.bmap.tips=function(a,b,c){a={input:document.querySelector(a),location:b};var d,e;return c&&(c.types&&(a.types=c.types),c.oncomplete&&(a.onSearchComplete=c.oncomplete),"function"==typeof c.onselect&&(d=c.onselect),"function"==typeof c.onhover&&(e=c.onhover)),c=new BMap.Autocomplete(a),d&&c.addEventListener("onconfirm",function(a){d.call(this,a)}),e&&c.addEventListener("onhighlight",function(a){e.call(this,a)}),c}}();
